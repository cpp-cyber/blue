{{ template "Header" }}
<div class="container-fluid">
    <div class="row">
        <div id="agents" class="h-100 d-flex align-items-center justify-content-center row">
        </div>
    </div>

<script>
    $(document).ready(function () {
        GetAgents();
    });

    url = 'ws://localhost/ws/agent/web';
    var socket = new WebSocket(url);

    socket.onmessage = function(event) {
        var message = event.data;
        var data = JSON.parse(message);
        if (typeof data.ID !== 'undefined') {
            if (data.Status === "Alive") {
                if (document.getElementById(data.ID) === null) {
                    GetAgents();
                }
                AgentUp(data.ID);
            } else if (data.Status === "Dead") {
                AgentDown(data.ID);
            } else {
                console.log("Unknown status: ", data);
            }
        } else {
            console.log("Unknown message: ", data);
        }
    };

    socket.onopen = function(event) {
        console.log("Connection established!");
    };

    socket.onerror = function(error) {
        console.log("WebSocket Error: ", error);
    };

    socket.onclose = function(event) {
        console.log("Connection closed!");
    };


    var cardCount = 0;
    function GetAgents() {
        $.ajax({
            url: "/api/agents/get",
            type: "GET",
            dataType: "json",
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    if (document.getElementById(data[i][3]) === null) {
                        AddAgentCard(data[i][0], data[i][1], data[i][2], data[i][3]);
                        cardCount++;
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log("Error: " + error);
            },
        });
    }

    function AddAgentCard(hostname, os, ip, id) {
        var card = '<div class="col-md-4" style="max-width: 18rem;">' +
            '<div id="' + id + '" class="card text-bg-danger mb-3 col" style="max-width: 18rem;">' +
            '<div class="card-header">' + os + '</div>' +
            '<div class="card-body">' +
            '<h5 class="card-title">' + hostname + '</h5>' +
            '<p class="card-text">' + ip + '</p>' +
            '</div>' +
            '</div>' +
            '</div>';
        $("#agents").append(card);
    }

    function AgentDown(id) {
        document.getElementById(id).classList.remove("text-bg-success");
        document.getElementById(id).classList.add("text-bg-danger");
    }

    function AgentUp(id) {
        document.getElementById(id).classList.remove("text-bg-danger");
        document.getElementById(id).classList.add("text-bg-success");
    }

</script>
{{ template "Footer" }}
